<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href='data:application/manifest+json,{
      "display":"standalone", "start_url":"index.html",
      "name":"A♥️J 클라우드 메모", "short_name":"A♥️J클라우드 메모",
      "icons":[{
        "src":"https://b-o-o-x.github.io/pwa/cloud-memo/cloud-memo-512.png",
        "sizes":"512x512", "type":"image/png"
      }]
    }'/>
    <title>A❤️J 클라우드 메모</title>
    <link id="manifest-link" rel="manifest">
    <style>
        :root { --primary: #4285f4; --bg: #f0f2f5; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; background: var(--bg); -webkit-tap-highlight-color: transparent; }
        
        /* 헤더 */
        .header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 10; }
        
        /* 목록 뷰 */
        #listView { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .post-it { padding: 15px; height: 140px; border-radius: 12px; box-shadow: 2px 4px 10px rgba(0,0,0,0.08); cursor: pointer; display: flex; flex-direction: column; transition: 0.2s; border: 1px solid rgba(0,0,0,0.05); }
        .post-it:active { transform: scale(0.95); }
        .post-it .preview { font-size: 0.95em; color: #333; flex-grow: 1; overflow: hidden; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; word-break: break-all; }
        .post-it .date { font-size: 0.7em; color: rgba(0,0,0,0.5); margin-top: 8px; text-align: right; }
        
        /* 상세 뷰 */
        #detailView { display: none; padding: 20px; height: 100vh; flex-direction: column; box-sizing: border-box; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 20; transition: background-color 0.3s; }
        textarea { width: 100%; flex-grow: 1; border: none; padding: 15px; border-radius: 12px; font-size: 1.1em; resize: none; box-sizing: border-box; background: rgba(255,255,255,0.5); margin-bottom: 15px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.02); }
        textarea:focus { outline: none; background: rgba(255,255,255,0.8); }
        
        /* 색상 선택기 */
        .color-picker { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-dot.active { border-color: #333; transform: scale(1.2); }

        /* 버튼 */
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-add { background: var(--primary); color: white; position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; font-size: 35px; box-shadow: 0 4px 15px rgba(66,133,244,0.4); display: flex; align-items: center; justify-content: center; z-index: 15; }
        .btn-back { background: rgba(0,0,0,0.05); color: #333; }
        .btn-delete { background: #ff4444; color: white; }
        
        #status { font-size: 0.8em; color: #666; text-align: center; height: 20px; }
        .hidden { display: none !important; }
        #authSection { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; }
    </style>
</head>
<body>

<div id="authSection">
    <h1 style="color:var(--primary);">☁️ Cloud Memo</h1>
    <button onclick="login()" class="btn" style="background:#4285f4; color:white; padding:15px 40px;">Google로 시작하기</button>
</div>

<div id="mainSection" class="hidden">
    <div class="header">
        <b id="userInfo">내 메모</b>
        <button onclick="logout()" class="btn" style="background:none; color:#999;">로그아웃</button>
    </div>

    <div id="listView"></div>
    <div class="btn-add" onclick="createNewMemo()">+</div>

    <div id="detailView">
        <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <button class="btn btn-back" onclick="showList()">◀ 목록</button>
            <div>
                <button class="btn btn-delete" onclick="deleteMemo()" style="margin-right:8px;">삭제</button>
                <button class="btn" style="background:#34a853; color:white;" onclick="saveMemo()">저장</button>
            </div>
        </div>

        <div class="color-picker" id="colorPicker">
            <div class="color-dot" style="background: #fff9c4;" data-color="#fff9c4"></div>
            <div class="color-dot" style="background: #ffecb3;" data-color="#ffecb3"></div>
            <div class="color-dot" style="background: #e1f5fe;" data-color="#e1f5fe"></div>
            <div class="color-dot" style="background: #f1f8e9;" data-color="#f1f8e9"></div>
            <div class="color-dot" style="background: #fce4ec;" data-color="#fce4ec"></div>
        </div>

        <textarea id="memoInput" placeholder="내용을 입력하세요..."></textarea>
        <div id="status">대기 중</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, query, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDOpuYpod3hPPPBOMSdQkoAYhMRNLBAQy4",
        authDomain: "pwa-cloud-memo.firebaseapp.com",
        projectId: "pwa-cloud-memo",
        storageBucket: "pwa-cloud-memo.firebasestorage.app",
        messagingSenderId: "156306395907",
        appId: "1:156306395907:web:c801406de1d62b05390f36",
        measurementId: "G-6PZTMPG2ST"
      };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let isTyping = false; // 사용자가 실제로 입력 중인지 여부
    let typingTimer;      // 입력 중단 감지 타이머
    let currentUserId = null;
    let activeMemoId = null;
    let activeColor = "#fff9c4";
    let debounceTimer;
    let detailUnsubscribe = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserId = user.uid;
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            loadMemoList();
        } else {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
        }
    });

    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);

    // 목록 로드 (실시간)
    function loadMemoList() {
        const q = query(collection(db, "users", currentUserId, "memos"), orderBy("updatedAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const listView = document.getElementById('listView');
            listView.innerHTML = '';
            snapshot.forEach((doc) => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'post-it';
                div.style.backgroundColor = data.color || "#fff9c4";
                div.innerHTML = `
                    <div class="preview">${data.content || '내용 없음'}</div>
                    <div class="date">
                        ${data.updatedAt?.toDate().toLocaleDateString('ko-KR', {month:'short', day:'numeric'}) || ''} 
                        ${data.updatedAt?.toDate().toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit', hour12: false}) || '방금'}
                    </div>
                `;
                div.onclick = () => openMemo(doc.id, data.content, data.color);
                listView.appendChild(div);
            });
        });
    }

    window.createNewMemo = () => {
        activeMemoId = doc(collection(db, "users", currentUserId, "memos")).id;
        openMemo(activeMemoId, "", "#fff9c4");
    };

    window.openMemo = (id, content, color) => {
        activeMemoId = id;
        activeColor = color || "#fff9c4";
        const memoInput = document.getElementById('memoInput');
        memoInput.value = content;
        updateUIWithColor(activeColor);
        showDetail();

        if (detailUnsubscribe) detailUnsubscribe();
        detailUnsubscribe = onSnapshot(doc(db, "users", currentUserId, "memos", id), (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                const memoInput = document.getElementById('memoInput');
                
                // 사용자가 타이핑 중이 아닐 때만 업데이트
                if (!isTyping) {
                    if (memoInput.value !== data.content) {
                        // 1. 현재 커서의 시작/끝 위치를 기억해둡니다.
                        const start = memoInput.selectionStart;
                        const end = memoInput.selectionEnd;
        
                        // 2. 내용을 업데이트합니다.
                        memoInput.value = data.content;
                        updateUIWithColor(data.color || "#fff9c4");
        
                        // 3. 기억해둔 위치로 커서를 다시 복구합니다.
                        // (단, 포커스 상태일 때만 의미가 있으므로 체크해줍니다.)
                        if (document.activeElement === memoInput) {
                            memoInput.setSelectionRange(start, end);
                        }
        
                        document.getElementById('status').innerText = "☁️ 실시간 동기화 완료";
                    }
                }
            }
        });
    };

    function updateUIWithColor(color) {
        document.getElementById('detailView').style.backgroundColor = color;
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.classList.toggle('active', dot.dataset.color === color);
        });
    }

    // 색상 선택 이벤트
    document.querySelectorAll('.color-dot').forEach(dot => {
        dot.onclick = () => {
            activeColor = dot.dataset.color;
            updateUIWithColor(activeColor);
            saveMemo(); // 색상 변경 시 즉시 저장
        };
    });

    window.saveMemo = async () => {
        if (!activeMemoId) return;
        const content = document.getElementById('memoInput').value;
        const statusEl = document.getElementById('status');
        statusEl.innerText = "저장 중...";
        
        await setDoc(doc(db, "users", currentUserId, "memos", activeMemoId), {
            content: content,
            color: activeColor,
            updatedAt: serverTimestamp()
        }, { merge: true });
        
        const now = new Date();
        statusEl.innerText = `☁️ ${now.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit', hour12:false})} 저장됨`;
    };

    window.deleteMemo = async () => {
        if(confirm("삭제하시겠습니까?")) {
            await deleteDoc(doc(db, "users", currentUserId, "memos", activeMemoId));
            showList();
        }
    };

    document.getElementById('memoInput').addEventListener('input', () => {
        isTyping = true; // 타이핑 시작
        document.getElementById('status').innerText = "입력 중...";
        
        clearTimeout(debounceTimer);
        clearTimeout(typingTimer);
    
        // 1. 자동 저장용 타이머 (5초)
        debounceTimer = setTimeout(saveMemo, 5000);
    
        // 2. "입력 중단" 감지용 타이머 (2초 후부터는 서버 업데이트 허용)
        typingTimer = setTimeout(() => {
            isTyping = false;
        }, 2000); 
    });

    window.showDetail = () => {
        document.getElementById('detailView').style.display = 'flex';
        document.getElementById('memoInput').focus();
    };

    window.showList = () => {
        if (detailUnsubscribe) detailUnsubscribe();
        document.getElementById('detailView').style.display = 'none';
        activeMemoId = null;
    };
</script>

<script>
// 스크립트 맨 하단에 이것만 사용
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => {
            console.log("서비스 워커 등록 성공!");
        }).catch(err => {
            console.log("등록 실패:", err);
        });
    });
}
</script>
</body>
</html>
