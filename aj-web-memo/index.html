<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 클라우드 메모장</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #333; }
        textarea { width: 100%; height: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: none; font-size: 16px; box-sizing: border-box; }
        .controls { margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; transition: 0.3s; }
        #loginBtn { background-color: #4285f4; color: white; }
        #saveBtn { background-color: #34a853; color: white; }
        #status { font-size: 0.9em; color: #666; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>☁️ 실시간 클라우드 메모</h2>
    
    <div id="authSection">
        <p>메모를 이용하려면 로그인이 필요합니다.</p>
        <button id="loginBtn">구글로 시작하기</button>
    </div>

    <div id="memoSection" class="hidden">
        <p id="userInfo"></p>
        <textarea id="memoInput" placeholder="내용을 입력하세요..."></textarea>
        <div class="controls">
            <span id="status">상태: 대기 중</span>
            <button id="saveBtn">지금 저장</button>
        </div>
        <button id="logoutBtn" style="margin-top: 20px; background:#eee;">로그아웃</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 사용자님이 제공해주신 설정값
    const firebaseConfig = {
        apiKey: "AIzaSyA68QrJgmmYP0DCcZw2DCFML-lMgow5mzY",
        authDomain: "aj-web-memo.firebaseapp.com",
        projectId: "aj-web-memo",
        storageBucket: "aj-web-memo.firebasestorage.app",
        messagingSenderId: "38916141470",
        appId: "1:38916141470:web:18784f885170146105a68f",
        measurementId: "G-LLHD6FXFVE"
    };

    // 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // DOM 요소
    const memoInput = document.getElementById('memoInput');
    const saveBtn = document.getElementById('saveBtn');
    const status = document.getElementById('status');
    const memoSection = document.getElementById('memoSection');
    const authSection = document.getElementById('authSection');

    let debounceTimer;
    let isRemoteUpdate = false; // 외부 동기화로 인한 업데이트인지 확인용

    // 1. 로그인 상태 확인 및 데이터 바인딩
    onAuthStateChanged(auth, (user) => {
        if (user) {
            authSection.classList.add('hidden');
            memoSection.classList.remove('hidden');
            document.getElementById('userInfo').innerText = `${user.displayName}님의 메모장`;

            // 실시간 리스너 연결 (데이터가 바뀌면 즉시 실행)
            const memoRef = doc(db, "memos", user.uid);
            onSnapshot(memoRef, (docSnap) => {
                if (docSnap.exists() && !memoInput.matches(':focus')) {
                    // 사용자가 타이핑 중(포커스)이 아닐 때만 외부 변경사항 반영 (충돌 방지)
                    isRemoteUpdate = true;
                    memoInput.value = docSnap.data().content;
                    isRemoteUpdate = false;
                    status.innerText = "상태: 최신 버전 동기화됨";
                }
            });
        } else {
            authSection.classList.remove('hidden');
            memoSection.classList.add('hidden');
        }
    });

    // 2. 저장 함수
    async function saveToCloud() {
        const user = auth.currentUser;
        if (!user) return;

        status.innerText = "상태: 저장 중...";
        try {
            await setDoc(doc(db, "memos", user.uid), {
                content: memoInput.value,
                updatedAt: new Date()
            });
            status.innerText = "상태: 모든 변경사항 저장됨";
        } catch (e) {
            console.error(e);
            status.innerText = "상태: 저장 실패!";
        }
    }

    // 3. 디바운싱 로직 (5초)
    memoInput.addEventListener('input', () => {
        if (isRemoteUpdate) return; // 외부 업데이트로 인한 input 이벤트는 무시
        
        status.innerText = "상태: 입력 중...";
        clearTimeout(debounceTimer); // 기존 타이머 취소
        debounceTimer = setTimeout(() => {
            saveToCloud(); // 5초간 입력 없으면 실행
        }, 5000);
    });

    // 4. 버튼 이벤트
    document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
    document.getElementById('logoutBtn').onclick = () => signOut(auth);
    saveBtn.onclick = saveToCloud;

</script>
</body>
</html>
